<%
  # BigBlueButton open source conferencing system - http://www.bigbluebutton.org/.
  # Copyright (c) 2018 BigBlueButton Inc. and by respective authors (see below).
  # This program is free software; you can redistribute it and/or modify it under the
  # terms of the GNU Lesser General Public License as published by the Free Software
  # Foundation; either version 3.0 of the License, or (at your option) any later
  # version.
  #
  # BigBlueButton is distributed in the hope that it will be useful, but WITHOUT ANY
  # WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
  # PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
  # You should have received a copy of the GNU Lesser General Public License along
  # with BigBlueButton; if not, see <http://www.gnu.org/licenses/>.
%>

<div class="background pb-1" is_moderator="<%= @is_moderator ? "yes" : "no" %>" is_neelz_room="<%= @is_neelz_room ? "yes" : "no" %>" room="<%= @current_room_inside %>" user="<%= current_user ? current_user.uid : "anonymous" %>">

  <% if @is_neelz_room && @user_browses %>
    <div id="inside_parent">
        <div id="inside_external_frame" style="display: block;">

            <% unless @is_moderator %>
              <div id="curtain_layer"></div>
              <div id="inside_external_frame_iframe_container">
            <% end %>

            <iframe title="Fragebogen" <% unless @is_moderator %> class="inside_attendee_external_iframe" <% end %>id="external_viewport_1"  <% unless @is_moderator || !@proband_readonly %> sandbox="allow-same-origin allow-scripts" <% end %> src="<%= @is_moderator ? session['neelz_url_interviewer'] : '' %>" allowfullscreen allow="autoplay *; fullscreen *; display-capture *; geolocation *; microphone *; camera *; midi *; encrypted-media *; vr *;" width="100%" height="100%" importance="high">
            </iframe>

            <% unless @is_moderator %>
              </div> <!-- end div inside_external_frame_iframe_container -->
            <% end %>

            <script type="text/javascript">

              let co_browsing = {active: false};

              function co_browsing_state_changed(activated){
                  if (activated) {
                      co_browsing.active = true;
                      $('#neelz_share_icon').removeClass('fa-eye-slash').addClass('fa-eye');
                      $('.fa-sync:before').css('color', 'white');
                  }else{
                      co_browsing.active = false;
                      $('#neelz_share_icon').removeClass('fa-eye').addClass('fa-eye-slash');
                      $('.fa-sync:before').css('color','gray');
                  }
              }

              function toggle_co_browsing_share(){
                  if (co_browsing.active){
                      $.post( "/neelz/unshare", function( data ) {
                          co_browsing_state_changed(false);
                      });
                  }else {
                      $.post("/neelz/share", function (data) {
                          co_browsing_state_changed(true);
                      });
                  }
              }

              function refresh_co_browsing(){
                  if (co_browsing.active){
                      $.post( "/neelz/refresh", function( data ) {

                      });
                  }
              }

              <% if @is_moderator && !@proband_readonly %>

                window.addEventListener("message", function(event) {
                    if (event.origin != '<%= Rails.configuration.neelz_i_share_base_url %>') {
                        return;
                    }
                    let posting = $.post('/neelz/i_share', JSON.parse(event.data));
                    posting.done(function (data) {
                        co_browsing_state_changed(true);
                    });
                });

              <% end %>


              $('#neelz_btn_toggle_share').click(toggle_co_browsing_share);
              $('#neelz_btn_refresh_share').click(refresh_co_browsing);
            </script>
        </div>

        <div id="inside_video_frame">
  <% end %>

            <iframe title="<%= @current_room_inside %>" id="client_viewport" allowfullscreen allow="autoplay *; fullscreen *; display-capture *; geolocation *; microphone *; camera *; midi *; encrypted-media *; vr *;" src="<%= @target_url_client %>" width="100%" height="100%" importance="high" referrer-policy="unsafe-url">

            </iframe>

  <% if @is_neelz_room && @user_browses %>
        </div>

    </div>

    <script type="text/javascript">
      let orientation_dim = {dim: 'unset', parent_height: 0, parent_width: 0, classh1: 'unset', classh2: 'unset',classv1: 'unset', classv2: 'unset'};
      let inside_parent = $("#inside_parent");
      let inside_video_frame = $('#inside_video_frame');
      let inside_external_frame = $("#inside_external_frame");

      function set_screen_split_layout(layout,no_update){
          switch (layout) {
            case 1:
                orientation_dim.classh1 = 'zero_width';
                orientation_dim.classh2 = 'full_width';
                orientation_dim.classv1 = 'zero_height';
                orientation_dim.classv2 = 'full_height';
                break;
            case 2:
                orientation_dim.classh1 = 'one_quarter_width';
                orientation_dim.classh2 = 'three_quarter_width';
                orientation_dim.classv1 = 'one_quarter_height';
                orientation_dim.classv2 = 'three_quarter_height';
                break;
            case 4:
                orientation_dim.classh1 = 'half_width';
                orientation_dim.classh2 = 'half_width';
                orientation_dim.classv1 = 'half_height';
                orientation_dim.classv2 = 'half_height';
                break;
            case 3:
                orientation_dim.classh1 = 'one_third_width';
                orientation_dim.classh2 = 'two_thirds_width';
                orientation_dim.classv1 = 'one_third_height';
                orientation_dim.classv2 = 'two_thirds_height';
                break;
            case 5:
                orientation_dim.classh2 = 'one_third_width';
                orientation_dim.classh1 = 'two_thirds_width';
                orientation_dim.classv2 = 'one_third_height';
                orientation_dim.classv1 = 'two_thirds_height';
                break;
            case 6:
                orientation_dim.classh2 = 'one_quarter_width';
                orientation_dim.classh1 = 'three_quarter_width';
                orientation_dim.classv2 = 'one_quarter_height';
                orientation_dim.classv1 = 'three_quarter_height';
                break;
            case 7:
                orientation_dim.classh2 = 'zero_width';
                orientation_dim.classh1 = 'full_width';
                orientation_dim.classv2 = 'zero_height';
                orientation_dim.classv1 = 'full_height';
                break;

          }
          if (!no_update) update_layout();
          $('.neelz-button-toggle').removeClass('neelz_screen_split_btn_down');
          $('#neelz_btn_split_'+layout).addClass('neelz_screen_split_btn_down');
      }

      function update_layout(){
          $('#inside_video_frame, #inside_external_frame')
              .removeClass('half_width').removeClass('half_height')
              .removeClass('one_third_width').removeClass('one_third_height')
              .removeClass('two_thirds_width').removeClass('two_thirds_height')
              .removeClass('one_quarter_width').removeClass('one_quarter_height')
              .removeClass('three_quarter_width').removeClass('three_quarter_height')
              .removeClass('zero_width').removeClass('zero_height')
              .removeClass('full_width').removeClass('full_height');
          if (orientation_dim.dim === 'vertical'){
              $('#inside_external_frame').addClass(orientation_dim.classv1);
              $('#inside_video_frame').addClass(orientation_dim.classv2);
          }else{
              $('#inside_external_frame').addClass(orientation_dim.classh1);
              $('#inside_video_frame').addClass(orientation_dim.classh2);
          }
      }

      function check_orientation() {
          if (inside_parent.width() >= 1945 && inside_parent.width() > inside_parent.height()) {
            if (orientation_dim.dim === 'vertical' || orientation_dim.dim === 'unset'){
                $('#inside_video_frame, #inside_external_frame')
                    .addClass('inside_frame_horizontal')
                    .removeClass('inside_frame_vertical');
                orientation_dim.dim = 'horizontal';
                update_layout();
            }
          } else {
              if (orientation_dim.dim === 'horizontal' || orientation_dim.dim === 'unset'){
                  $('#inside_video_frame, #inside_external_frame')
                      .addClass('inside_frame_vertical')
                      .removeClass('inside_frame_horizontal');
                  orientation_dim.dim = 'vertical';
                  update_layout();
              }
          }
      }

      $(window).resize(function(){
          check_orientation();
      });

      $(document).ready(function () {
          <% if @is_moderator %>
            set_screen_split_layout(5, true);
          <% else %>
            set_screen_split_layout(1, true);
          <% end %>
          check_orientation();
          for (let i=1;i<=7;i++){
              $('#neelz_btn_split_'+i).click((function(_i){
                return function () {
                  set_screen_split_layout(_i);
              }})(i));
          }
      });

    </script>
  <% end %>
</div>